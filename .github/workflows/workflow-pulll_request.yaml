name: CI Pipeline para Pull-Requests e Build/Push de Imagem

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:

  lint:
    name: Executa ESLint para checar estilo de codificação
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Instala Node.js versão 20 (com cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instala dependências
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  test:
    name: Executa testes com cobertura
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Instala Node.js versão 20 (com cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Instala dependências
        run: npm ci

      - name: Requer 90% de cobertura dos testes
        run: npm run test -- --coverage

  docker_build:
    name: Build da imagem Docker
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Define nome da imagem
        run: echo "IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/gc-2-api-livros" >> $GITHUB_ENV

      - name: Build da imagem Docker
        run: |
          docker build -t $IMAGE:latest -t $IMAGE:${{ github.sha }} .

      - name: Salva tags como artefato
        run: |
          echo "$IMAGE:latest" > image_latest.txt
          echo "$IMAGE:${{ github.sha }}" > image_sha.txt

      - uses: actions/upload-artifact@v4
        with:
          name: docker-tags
          path: |
            image_latest.txt
            image_sha.txt

  docker_publish:
    name: Publica imagem no Docker Hub
    runs-on: ubuntu-latest
    needs: docker_build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Baixa artefatos do build
        uses: actions/download-artifact@v4
        with:
          name: docker-tags

      - name: Lê variáveis de imagem
        run: |
          echo "IMAGE_LATEST=$(cat image_latest.txt)" >> $GITHUB_ENV
          echo "IMAGE_SHA=$(cat image_sha.txt)" >> $GITHUB_ENV

      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push da imagem para o Docker Hub
        run: |
          docker push $IMAGE_LATEST
          docker push $IMAGE_SHA